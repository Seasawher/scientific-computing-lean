<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Optimizing Array Expressions - Scientific Computing in Lean</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">
        <link rel="stylesheet" href="../pygments.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../title.html">Scientific Computing in Lean</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/sorry-friendly-programming.html"><strong aria-hidden="true">1.1.</strong> Sorry Friendly Programming</a></li></ol></li><li class="chapter-item expanded "><a href="../working-with-arrays.html"><strong aria-hidden="true">2.</strong> Working with Arrays</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../working-with-arrays/basics.html"><strong aria-hidden="true">2.1.</strong> Basic Operations</a></li><li class="chapter-item expanded "><a href="../working-with-arrays/tensor-operations.html"><strong aria-hidden="true">2.2.</strong> Tensor Operations</a></li><li class="chapter-item expanded "><a href="../working-with-arrays/abstract-interface.html"><strong aria-hidden="true">2.3.</strong> Abstract Array Interface</a></li><li class="chapter-item expanded "><a href="../working-with-arrays/optimizing-arrays.html" class="active"><strong aria-hidden="true">2.4.</strong> Optimizing Array Expressions</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Differentiation</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> Zoo of Differentiation Operators</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Defining New Functions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Theoretical Aspects*</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Function Transformations</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> Defining New Function Transformation</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> Function Transformation Algorithm*</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Problem Transformations</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Solve Function</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.</strong> Approximation</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Differential Equations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Probabilistic Programming</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Scientific Computing in Lean</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="optimizing-array-expressions"><a class="header" href="#optimizing-array-expressions">Optimizing Array Expressions</a></h1>
<p><em>Show how one can optimize array expressin</em></p>
<ul>
<li><em>explain how Lean can be used as interactive compiler</em></li>
<li><em>simple BLAS oprations like <code>c = a*x + y</code> and turn it into <code>c = map x (fun i xi =&gt; a*xi + y[i]</code></em></li>
<li><em>issue with multidimensional indices and conversion to linear indices</em></li>
</ul>
<p>Lean is an interactive theorems prover and in this chapter we will show how to use Lean as interactive compiler/computer algebra system. An exmaple of common compiler optimization with arrays is loop fusion i.e. merging two loop into one. We will show how to craft such optimizations, expore them interactively and how to automate them. </p>
<p>We can view program optimization as rerwiting a program into another program that is equal and by equal we mean that for the same input these programs produce the same output. There is a very close parallel to theorem proving. Very often to prove equality <code>x = y</code> we just simplify <code>x</code> to <code>x'</code> and <code>y</code> to <code>y'</code> and if <code>x'</code> happends to be identical to <code>y'</code> we have just proven that <code>x = y</code>. Lean provides a general pupose expression simplifier, called <code>simp</code>, which has a database of rewrite rules and tries to apply them to subexpression. </p>
<p>For example, in Lean there is theorem that adding zero does not change the value. </p>
<pre><code>@[simp] theorem Nat.add_zero (n : Nat) : n + 0 = n := rfl
</code></pre>
<p>Adding this attribute <code>@[simp]</code> adds this theorem to the <code>simp</code>'s database of theorems it tries to apply. </p>
<p>We can simplify any expression <code>e</code> by <code>e rewrite_by simp</code></p>
<pre><code>#check (0 + 5 + 0) rewrite_by simp
</code></pre>
<p>which returns <code>5 : ℕ</code> i.e. all the zero adition has been eliminated. We can actually inspect what did the simplifier did by turning on some options</p>
<pre><code>set_option trace.Meta.Tactic.simp.rewrite true in
#check (0 + 5 + 0) rewrite_by simp
</code></pre>
<p>produces</p>
<pre><code>[Meta.Tactic.simp.rewrite] @zero_add:1000, 0 + 5 ==&gt; 5
[Meta.Tactic.simp.rewrite] @add_zero:1000, 5 + 0 ==&gt; 5
</code></pre>
<p>So we can see that the simplifier first simplifies the subexpression <code>0 + 5</code> to <code>5</code> and then <code>5 + 0</code> to <code>5</code>.</p>
<p>The simplifier has many options and configurations. By default <code>simp</code> uses all the theorems marked with <code>simp</code>. Often it is usefull to narrow it down to only a specific set of theorems. You can call <code>simp only</code> which does not use any theorems at all, it just preforms basic lambda claclus reductions, like beta reduction which turns <code>(fun x =&gt; f x) y</code> to <code>f y</code>. To give explicit set of theorems to use use squared brackets <code>simp only [add_zero]</code></p>
<pre><code>#check (0 + 5 + 0) rewrite_by simp only [add_zero]
</code></pre>
<p>produces <code>0 + 5</code> as only the rewrite by <code>add_zero</code> is allowed. </p>
<p>What does this have to do with programs optimization? Consider this theorem</p>
<pre><code>theorem mapMono_mapMono {I} [IndexType I] (x : Float^[I]) (f g : Float → Float) :
    (x.mapMono f |&gt;.mapMono g) = x.mapMono fun x =&gt; f (g x) := ...
</code></pre>
<p>which fuses two <code>mapMono</code> into one. </p>
<p>Recall <code>softMax</code> from previous chapter</p>
<pre><code>def softMax {I} [IndexType I]
  (r : Float) (x : Float^[I]) : Float^[I] := Id.run do
  let m := x.reduce (max · ·)
  let x := x.mapMono fun x =&gt; x-m
  let x := x.mapMono fun x =&gt; exp r*x
  let w := x.reduce (·+·)
  let x := x.mapMono fun x =&gt; x/w
  return x
</code></pre>
<p>We can defined &quot;optimized&quot; version </p>
<pre><code>def softMax_optimized {I} [IndexType I] (r : Float) (x : Float^[I]) := 
    (softMax r x) rewrite_by unfold softmax; simp only [mapMono_mapMono]
</code></pre>
<p>where we first unfold the definition of <code>softMax</code> by <code>unfold softMax</code> and then apply the theorem <code>mapMono_mapMono</code> through simplifier. If you plase cursor at the and of <code>simp only [mapMono_mapMono]</code> you will see the resulting expression</p>
<pre><code>Id.run
    (pure
      (DataArrayN.mapMono x fun x_1 =&gt;
        exp r *
            (x_1 /
              DataArrayN.reduce (DataArrayN.mapMono x fun x_2 =&gt; exp r * x_2 - DataArrayN.reduce x fun x x_3 =&gt; max x x_3)
                fun x x_2 =&gt; x + x_2) -
          DataArrayN.reduce x fun x x_2 =&gt; max x x_2))
</code></pre>
<p>This is a bit of an incomprehensible mess. The issue is that <code>simp</code> by default destroys let bindings. This is because <code>simp</code> was originally devised for simplifying expressions not programs. To keep let bindings intact we can turn on zeta reduction <code>(config:={zeta:=false})</code></p>
<pre><code>def softMax_optimized {I} [IndexType I] (r : Float) (x : Float^[I]) := 
    (softMax r x) rewrite_by unfold softmax; simp (config:={zeta:=false, }) only [mapMono_mapMono]
</code></pre>
<p>but now the theorem can't be applied as the let bindings are blocking it.</p>
<p>Dealing correctly with let bindings a tricky problem and right now we will just do it manually. We can call <code>let_unfold x</code> which will destroy the first let binding with the name <code>x</code>. </p>
<pre><code>def softMax_optimized {I} [IndexType I] (r : Float) (x : Float^[I]) := 
    (softMax r x) 
    rewrite_by 
      unfold softmax
      let_unfold x
      simp (config:={zeta:=false}) only [mapMono_mapMono]
</code></pre>
<p>The result is</p>
<pre><code>Id.run
    (let m := x.reduce fun x x_1 =&gt; max x x_1;
    let x := x.mapMono fun x =&gt; exp r * x - m;
    let w := x.reduce fun x x_1 =&gt; x + x_1;
    let x := x.mapMono fun x =&gt; x / w;
    pure x)
</code></pre>
<p>...</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../working-with-arrays/abstract-interface.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../working-with-arrays/abstract-interface.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
